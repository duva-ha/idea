<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>ƒêI·ªÄU PH·ªêI T·∫§T NI√äN 2025 - XU√ÇN B√çNH NG·ªå 2026</title>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root { --gold: #ffeb3b; --red-bg: #8b0000; --dark: #310000; --glass: rgba(0,0,0,0.8); }
        body { font-family: 'Segoe UI', sans-serif; background: radial-gradient(circle, var(--red-bg), var(--dark)); color: white; margin: 0; display: flex; flex-direction: column; min-height: 100vh; overflow-x: hidden; }
        
        .header { background: #000; padding: 15px; border-bottom: 3px solid var(--gold); text-align: center; font-size: 1.5rem; font-weight: 900; color: var(--gold); letter-spacing: 2px; }
        
        .layout { display: flex; gap: 20px; padding: 20px; flex: 1; }

        /* C·ªôt tr√°i: Qu·∫£n l√Ω Karaoke */
        .karaoke-panel { flex: 1.2; background: var(--glass); border-radius: 20px; border: 1px solid var(--gold); padding: 20px; display: flex; flex-direction: column; }
        .kara-list { flex: 1; overflow-y: auto; text-align: left; margin-top: 15px; }
        .kara-item { 
            background: rgba(255,255,255,0.1); padding: 12px; border-radius: 10px; margin-bottom: 8px; 
            border-left: 4px solid var(--gold); display: flex; align-items: center; justify-content: space-between;
        }
        .kara-item.is-done { opacity: 0.5; border-left-color: #666; background: rgba(0,0,0,0.3); }
        .kara-info { flex: 1; margin-right: 10px; }
        .kara-item b { color: var(--gold); }
        
        /* Style cho n√∫t check */
        .check-btn { 
            background: #28a745; color: white; border: none; border-radius: 5px; 
            padding: 5px 10px; cursor: pointer; font-size: 0.8rem; font-weight: bold;
        }
        .check-btn:disabled { background: #444; cursor: not-allowed; }

        /* C·ªôt gi·ªØa: 36 l·ªìng quay */
        .draw-panel { flex: 2.5; background: var(--glass); border-radius: 20px; padding: 20px; border: 1px solid var(--gold); text-align: center; }
        .winner-row { display: flex; align-items: center; gap: 15px; background: rgba(0,0,0,0.5); padding: 8px 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid rgba(255,235,59,0.2); }
        .row-label { font-weight: 900; color: var(--gold); min-width: 70px; }
        .slot-group { display: flex; gap: 5px; }
        .slot { width: 50px; height: 75px; background: #000; border: 2px solid #444; border-radius: 8px; font-size: 3rem; font-weight: 900; display: flex; align-items: center; justify-content: center; }
        .spinning { color: #00ff00; border-color: #00ff00; }
        .final { color: white; border-color: var(--gold); text-shadow: 0 0 10px var(--gold); }
        .winner-name { flex: 1; text-align: left; padding-left: 15px; font-size: 1.3rem; font-weight: bold; color: var(--gold); }

        /* C·ªôt ph·∫£i: ƒêi·ªÅu khi·ªÉn */
        .control-panel { flex: 0.8; background: var(--glass); border-radius: 20px; border: 1px solid var(--gold); padding: 20px; text-align: center; }
        #qrcode { background: white; padding: 10px; border-radius: 10px; display: inline-block; }
        .btn-mega { width: 100%; padding: 20px; font-size: 1.5rem; font-weight: 900; background: linear-gradient(to bottom, #ffeb3b, #fbc02d); color: #8b0000; border: none; border-radius: 50px; cursor: pointer; box-shadow: 0 8px 0 #f57f17; margin-top: 20px; }
        .btn-mega:active { transform: translateY(4px); box-shadow: 0 4px 0 #f57f17; }
        input[type=range] { width: 100%; accent-color: var(--gold); }
    </style>
</head>
<body>

<div class="header">üßß ƒêI·ªÄU PH·ªêI ƒê·∫†I TI·ªÜC T·∫§T NI√äN 2025 - XU√ÇN B√çNH NG·ªå 2026 üßß</div>

<div class="layout">
    <div class="karaoke-panel">
        <h3 style="margin:0; color: var(--gold);">üé§ DANH S√ÅCH H√ÅT (THEO TH·ª® T·ª∞)</h3>
        <div id="karaList" class="kara-list">
            <div style="color: #666;">ƒêang t·∫£i danh s√°ch...</div>
        </div>
    </div>

    <div class="draw-panel">
        <div id="megaUI"></div>
        <div id="mainMsg" style="margin-top:15px; font-size:1.5rem; font-weight:bold; color:var(--gold);">S·∫¥N S√ÄNG QUAY TH∆Ø·ªûNG</div>
    </div>

    <div class="control-panel">
        <div id="qrcode"></div>
        <div style="margin: 20px 0;">
            <div style="font-size: 2.5rem; font-weight: 900; color: var(--gold);" id="totalCount">0</div>
            <div style="font-size: 0.8rem; color: #aaa;">NG∆Ø·ªúI THAM GIA</div>
        </div>
        <div style="font-size: 0.7rem; color: #666; margin-bottom: 5px;">√ÇM L∆Ø·ª¢NG</div>
        <input type="range" min="0" max="1" step="0.1" value="0.5" oninput="updateVol(this.value)">
        <button class="btn-mega" id="spinBtn" onclick="handleMegaSpin()">QUAY TH∆Ø·ªûNG</button>
        <button onclick="resetData()" style="margin-top:30px; background:none; border:none; color:rgba(255,255,255,0.3); cursor:pointer; text-decoration:underline;">X√≥a to√†n b·ªô d·ªØ li·ªáu</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCZs0sGNdMxeS9cL_g9HeMf1LOlxzOUKf4",
        authDomain: "chamtn-26e8f.firebaseapp.com",
        projectId: "chamtn-26e8f",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const spinSound = new Audio("https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3");
    const winSound = new Audio("https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3");
    spinSound.loop = true;
    function updateVol(v) { spinSound.volume = v; winSound.volume = v; }

    // Kh·ªüi t·∫°o l·ªìng quay
    const ui = document.getElementById('megaUI');
    for (let r = 1; r <= 6; r++) {
        ui.innerHTML += `
            <div class="winner-row">
                <div class="row-label">GI·∫¢I ${r}</div>
                <div class="slot-group">
                    ${Array(6).fill(0).map((_, s) => `<div id="r${r}s${s+1}" class="slot">0</div>`).join('')}
                </div>
                <div class="winner-name" id="name${r}">---</div>
            </div>`;
    }

    // L·∫Øng nghe danh s√°ch v√† c·∫≠p nh·∫≠t UI
    db.collection("participants").orderBy("ts", "asc").onSnapshot(snap => {
        document.getElementById('totalCount').innerText = snap.size;
        const karaList = document.getElementById('karaList');
        karaList.innerHTML = "";
        
        let counter = 1;
        snap.forEach(doc => {
            const d = doc.data();
            const id = doc.id;
            if(d.song && d.song !== "Kh√¥ng ƒëƒÉng k√Ω") {
                const isDone = d.isDone === true;
                karaList.innerHTML += `
                    <div class="kara-item ${isDone ? 'is-done' : ''}">
                        <div class="kara-info">
                            #${counter} - <b>${d.name}</b><br>
                            <small>üéµ ${d.song}</small>
                        </div>
                        <button class="check-btn" 
                                onclick="markAsDone('${id}')" 
                                ${isDone ? 'disabled' : ''}>
                            ${isDone ? '‚úì Xong' : 'Check'}
                        </button>
                    </div>`;
                counter++;
            }
        });
        if(counter === 1) karaList.innerHTML = "<div style='color:#666'>Ch∆∞a c√≥ b√†i ƒëƒÉng k√Ω...</div>";
    });

    // H√†m ƒë√°nh d·∫•u ƒë√£ h√°t - Kh√¥ng th·ªÉ ƒë·∫£o ng∆∞·ª£c
    async function markAsDone(docId) {
        if(confirm("X√°c nh·∫≠n ng∆∞·ªùi n√†y ƒë√£ h√°t xong?")) {
            await db.collection("participants").doc(docId).update({
                isDone: true
            });
        }
    }

    async function handleMegaSpin() {
        const snap = await db.collection("participants").get();
        if (snap.size < 6) return alert("C·∫ßn t·ªëi thi·ªÉu 6 ng∆∞·ªùi!");

        document.getElementById('spinBtn').disabled = true;
        spinSound.currentTime = 0; spinSound.play().catch(()=>{});

        let list = snap.docs.map(d => d.data());
        let winners = [];
        for (let i = 0; i < 6; i++) {
            winners.push(list.splice(Math.floor(Math.random() * list.length), 1)[0]);
        }

        await db.collection("system_status").doc("current_draw").set({
            status: "SPINNING",
            winners: winners,
            ts: Date.now()
        });

        let promises = winners.map((winner, rIdx) => {
            return new Promise(async (resolve) => {
                const r = rIdx + 1;
                document.getElementById(`name${r}`).innerText = "ƒêANG QUAY...";
                for (let s = 1; s <= 6; s++) {
                    const el = document.getElementById(`r${r}s${s}`);
                    el.classList.add('spinning'); el.classList.remove('final');
                    let start = Date.now();
                    while (Date.now() - start < (2000 + rIdx * 800 + s * 200)) {
                        el.innerText = Math.floor(Math.random() * 10);
                        await new Promise(res => setTimeout(res, 50));
                    }
                    el.innerText = winner.number[s-1];
                    el.classList.remove('spinning'); el.classList.add('final');
                }
                document.getElementById(`name${r}`).innerText = winner.name.toUpperCase();
                winSound.play();
                resolve();
            });
        });

        await Promise.all(promises);
        spinSound.pause();
        confetti({ particleCount: 300, spread: 160, origin: { y: 0.6 } });
        document.getElementById('spinBtn').disabled = false;
        await db.collection("system_status").doc("current_draw").update({ status: "DONE" });
    }

    // QRCode: T·ª± ƒë·ªông nh·∫≠n di·ªán link hi·ªán t·∫°i ƒë·ªÉ tr·ªè t·ªõi trang dangky.html
    const currentPath = window.location.pathname;
    const regUrl = window.location.origin + currentPath.replace('index.html', 'dangky.html');
    new QRCode(document.getElementById("qrcode"), { text: regUrl, width: 120, height: 120 });

    async function resetData() { 
        if(confirm("X√≥a to√†n b·ªô d·ªØ li·ªáu (Bao g·ªìm Karaoke v√† ng∆∞·ªùi tham gia)?")) { 
            const s = await db.collection("participants").get(); 
            const b = db.batch(); 
            s.docs.forEach(d => b.delete(d.ref)); 
            await b.commit(); 
            location.reload(); 
        } 
    }
</script>
</body>
</html>
