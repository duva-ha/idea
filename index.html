<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Xu√¢n App 2026 - Check-in H·ªìng K√¥ng</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: 'Segoe UI', Arial, sans-serif; }
        #container { position: relative; width: 100vw; height: 100vh; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        video { display: none; } /* ·∫®n video g·ªëc ƒë·ªÉ ch·ªâ hi·ªán canvas ƒë√£ x·ª≠ l√Ω */

        .controls { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); z-index: 100; 
                    background: rgba(0,0,0,0.6); padding: 20px; border-radius: 50px; display: flex; gap: 15px; backdrop-filter: blur(10px); box-shadow: 0 5px 20px rgba(0,0,0,0.4); }
        button { padding: 15px 30px; border: none; border-radius: 30px; cursor: pointer; font-weight: bold; color: white; transition: 0.3s; font-size: 1.1em; }
        
        .btn-modern { background: linear-gradient(45deg, #00c6ff, #0072ff); }
        .btn-hongkong { background: linear-gradient(45deg, #d32f2f, #ff416c); }
        .btn-snap { background: #ffd700; color: #333; font-size: 1.2em; box-shadow: 0 0 15px #ffd700; }
        
        #countdown { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                    color: white; font-size: 180px; font-weight: bold; z-index: 200; display: none; text-shadow: 0 0 20px rgba(0,0,0,0.7); }
    </style>
</head>
<body>

<div id="container">
    <video id="video" autoplay playsinline></video>
    <canvas id="mainCanvas"></canvas>
    <div id="countdown">3</div>

    <div class="controls">
        <button class="btn-modern" onclick="setMode('modern')">üíé HI·ªÜN ƒê·∫†I (BI·ªÇN)</button>
        <button class="btn-hongkong" onclick="setMode('hongkong')">üèÆ H·ªíNG K√îNG ƒê∆Ø·ªúNG PH·ªê</button>
        <button class="btn-snap" onclick="startCapture()">üì∏ CH·ª§P TO√ÄN M√ÄN H√åNH</button>
    </div>
</div>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    let currentMode = 'modern';

    // T·∫£i ·∫£nh n·ªÅn ch·∫•t l∆∞·ª£ng cao
    const bgBeach = new Image();
    bgBeach.src = 'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=1920&auto=format&fit=crop&q=80'; // ·∫¢nh bi·ªÉn
    const bgHongKong = new Image();
    bgHongKong.src = 'https://images.unsplash.com/photo-1596541539266-9b81e8f3d611?w=1920&auto=format&fit=crop&q=80'; // ·∫¢nh ƒë∆∞·ªùng ph·ªë H·ªìng K√¥ng

    // C·∫•u h√¨nh AI MediaPipe Selfie Segmentation
    const selfieSegmentation = new SelfieSegmentation({
        locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${file}`
    });
    selfieSegmentation.setOptions({ modelSelection: 1 }); // 0 cho nhanh, 1 cho ch·∫•t l∆∞·ª£ng cao
    selfieSegmentation.onResults(onResults);

    // M·ªü Camera ch·∫•t l∆∞·ª£ng cao nh·∫•t c√≥ th·ªÉ
    navigator.mediaDevices.getUserMedia({ video: { width: { ideal: 1920 }, height: { ideal: 1080 } } })
        .then(stream => {
            video.srcObject = stream;
            video.onloadeddata = () => {
                // ƒê·∫£m b·∫£o video ƒë√£ t·∫£i ƒë·ªß d·ªØ li·ªáu tr∆∞·ªõc khi g·ª≠i t·ªõi AI
                selfieSegmentation.send({image: video});
            };
        }).catch(error => {
            console.error("L·ªói khi truy c·∫≠p camera:", error);
            alert("Kh√¥ng th·ªÉ truy c·∫≠p camera. Vui l√≤ng ki·ªÉm tra quy·ªÅn truy c·∫≠p!");
        });

    function onResults(results) {
        // C·∫≠p nh·∫≠t k√≠ch th∆∞·ªõc canvas theo c·ª≠a s·ªï tr√¨nh duy·ªát
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        ctx.save();
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // B∆Ø·ªöC 1: V·∫Ω ph·∫ßn ng∆∞·ªùi ƒë√£ ƒë∆∞·ª£c t√°ch n·ªÅn
        ctx.translate(canvas.width, 0);
        ctx.scale(-1, 1); // L·∫≠t g∆∞∆°ng ƒë·ªÉ ·∫£nh hi·ªÉn th·ªã ƒë√∫ng
        ctx.drawImage(results.segmentationMask, 0, 0, canvas.width, canvas.height); // V·∫Ω mask ƒë·ªÉ ƒë·ªãnh h√¨nh ng∆∞·ªùi
        
        ctx.globalCompositeOperation = 'source-in'; // Ch·ªâ gi·ªØ l·∫°i ph·∫ßn h√¨nh ·∫£nh n·∫±m trong mask
        ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height); // V·∫Ω h√¨nh ·∫£nh ng∆∞·ªùi
        
        // B∆Ø·ªöC 2: V·∫Ω n·ªÅn (ch√®n v√†o ph√≠a sau ph·∫ßn ng∆∞·ªùi)
        ctx.globalCompositeOperation = 'destination-over'; 
        const bg = currentMode === 'modern' ? bgBeach : bgHongKong;
        ctx.drawImage(bg, 0, 0, canvas.width, canvas.height);
        
        ctx.restore(); // Kh√¥i ph·ª•c tr·∫°ng th√°i canvas
        ctx.globalCompositeOperation = 'source-over'; // ƒê·∫∑t l·∫°i ch·∫ø ƒë·ªô v·∫Ω

        // Ti·∫øp t·ª•c g·ª≠i frame video t·ªõi AI ƒë·ªÉ x·ª≠ l√Ω li√™n t·ª•c
        requestAnimationFrame(() => selfieSegmentation.send({image: video}));
    }

    // Ch·ª©c nƒÉng ƒë·ªïi ch·∫ø ƒë·ªô (Bi·ªÉn ho·∫∑c H·ªìng K√¥ng)
    function setMode(mode) { 
        currentMode = mode; 
        // Force re-render ƒë·ªÉ c·∫≠p nh·∫≠t n·ªÅn ngay l·∫≠p t·ª©c
        if(video.srcObject) {
            selfieSegmentation.send({image: video});
        }
    }

    // Ch·ª©c nƒÉng ƒë·∫øm ng∆∞·ª£c v√† ch·ª•p ·∫£nh
    function startCapture() {
        let timer = 3;
        const cd = document.getElementById('countdown');
        cd.style.display = 'block';
        const interval = setInterval(() => {
            timer--;
            cd.innerText = timer;
            if(timer === 0) {
                clearInterval(interval);
                cd.style.display = 'none';
                const link = document.createElement('a');
                link.download = `Checkin_Xuan2026_${currentMode}.png`;
                link.href = canvas.toDataURL(); // L·∫•y ·∫£nh t·ª´ canvas ƒë√£ x·ª≠ l√Ω
                link.click();
            }
        }, 1000);
    }
</script>
</body>
</html>
