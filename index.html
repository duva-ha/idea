<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Xu√¢n App 2026 - To√†n M√†n H√¨nh</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; }
        #container { position: relative; width: 100vw; height: 100vh; }
        canvas { width: 100%; height: 100%; object-fit: cover; }
        video { display: none; } /* ·∫®n video g·ªëc ƒë·ªÉ ch·ªâ hi·ªán canvas ƒë√£ x·ª≠ l√Ω */

        .controls { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); z-index: 100; 
                    background: rgba(0,0,0,0.6); padding: 20px; border-radius: 50px; display: flex; gap: 15px; backdrop-filter: blur(10px); }
        button { padding: 15px 30px; border: none; border-radius: 30px; cursor: pointer; font-weight: bold; color: white; transition: 0.3s; }
        .btn-modern { background: linear-gradient(45deg, #00c6ff, #0072ff); }
        .btn-classic { background: linear-gradient(45deg, #d32f2f, #ff416c); }
        .btn-snap { background: #ffd700; color: #000; font-size: 1.1em; box-shadow: 0 0 15px #ffd700; }
        
        #countdown { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                    color: white; font-size: 180px; font-weight: bold; z-index: 200; display: none; }
    </style>
</head>
<body>

<div id="container">
    <video id="video" autoplay playsinline></video>
    <canvas id="mainCanvas"></canvas>
    <div id="countdown">3</div>

    <div class="controls">
        <button class="btn-modern" onclick="setMode('modern')">üíé HI·ªÜN ƒê·∫†I (BI·ªÇN)</button>
        <button class="btn-classic" onclick="setMode('classic')">üå∏ C·ªî ƒêI·ªÇN (HOA ƒê√ÄO)</button>
        <button class="btn-snap" onclick="startCapture()">üì∏ CH·ª§P G√ìC R·ªòNG</button>
    </div>
</div>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    let currentMode = 'modern';
    let particles = [];

    // T·∫£i ·∫£nh n·ªÅn
    const bgBeach = new Image();
    bgBeach.src = 'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=1920'; // ·∫¢nh bi·ªÉn g√≥c r·ªông
    const bgTet = new Image();
    bgTet.src = 'https://images.unsplash.com/photo-1577041530932-9017f766e440?w=1920'; // N·ªÅn ƒë·ªè c·ªï ƒëi·ªÉn

    // C·∫•u h√¨nh AI MediaPipe
    const selfieSegmentation = new SelfieSegmentation({
        locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${file}`
    });
    selfieSegmentation.setOptions({ modelSelection: 1 });
    selfieSegmentation.onResults(onResults);

    // M·ªü Camera ch·∫•t l∆∞·ª£ng cao nh·∫•t
    navigator.mediaDevices.getUserMedia({ video: { width: { ideal: 1920 }, height: { ideal: 1080 } } })
        .then(stream => {
            video.srcObject = stream;
            video.onloadeddata = () => selfieSegmentation.send({image: video});
        });

    function onResults(results) {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        ctx.save();
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // B∆Ø·ªöC 1: V·∫Ω ng∆∞·ªùi (T√°ch t·ª´ Camera)
        ctx.translate(canvas.width, 0);
        ctx.scale(-1, 1); // L·∫≠t g∆∞∆°ng
        ctx.drawImage(results.segmentationMask, 0, 0, canvas.width, canvas.height);
        
        ctx.globalCompositeOperation = 'source-in'; // Ch·ªâ gi·ªØ l·∫°i ph·∫ßn ng∆∞·ªùi
        ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);
        
        // B∆Ø·ªöC 2: V·∫Ω n·ªÅn (Ch√®n v√†o ph√≠a sau)
        ctx.globalCompositeOperation = 'destination-over'; 
        const bg = currentMode === 'modern' ? bgBeach : bgTet;
        ctx.drawImage(bg, 0, 0, canvas.width, canvas.height);
        
        ctx.restore();

        // B∆Ø·ªöC 3: V·∫Ω hoa/tuy·∫øt bay ƒë·∫ßy m√†n h√¨nh
        drawParticles();
        
        // L·∫∑p l·∫°i AI
        requestAnimationFrame(() => selfieSegmentation.send({image: video}));
    }

    function drawParticles() {
        if (particles.length < 60) {
            particles.push({
                x: Math.random() * canvas.width,
                y: -20,
                r: Math.random() * 8 + 4,
                s: Math.random() * 3 + 1,
                o: Math.random()
            });
        }
        particles.forEach((p, i) => {
            p.y += p.s;
            p.x += Math.sin(p.y/50);
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
            ctx.fillStyle = currentMode === 'modern' ? `rgba(255,255,255,${p.o})` : `rgba(255,182,197,${p.o})`;
            ctx.fill();
            if(p.y > canvas.height) particles.splice(i, 1);
        });
    }

    function setMode(mode) { currentMode = mode; particles = []; }

    function startCapture() {
        let timer = 3;
        const cd = document.getElementById('countdown');
        cd.style.display = 'block';
        const interval = setInterval(() => {
            timer--;
            cd.innerText = timer;
            if(timer === 0) {
                clearInterval(interval);
                cd.style.display = 'none';
                const link = document.createElement('a');
                link.download = 'Xuan2026_AI.png';
                link.href = canvas.toDataURL();
                link.click();
            }
        }, 1000);
    }
</script>
</body>
</html>
