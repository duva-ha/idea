<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>S·ª∞ KI·ªÜN T·∫§T NI√äN - QUAY S·ªê MAY M·∫ÆN</title>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root { --tet-red: #d32f2f; --tet-gold: #ffeb3b; --bg: #8b0000; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; margin: 0; text-align: center; }
        .header { background: #5d0000; padding: 20px; border-bottom: 3px solid var(--tet-gold); }
        .main-container { max-width: 1200px; margin: auto; padding: 20px; display: flex; gap: 20px; }
        
        .card { background: rgba(0,0,0,0.5); border-radius: 25px; padding: 30px; border: 2px solid var(--tet-gold); flex: 3; }
        .sidebar { flex: 1; background: rgba(255,255,255,0.1); padding: 20px; border-radius: 25px; border: 1px solid var(--tet-gold); }

        /* L·ªìng quay */
        .slot-group { display: flex; justify-content: center; gap: 10px; margin: 30px 0; }
        .slot { width: 80px; height: 120px; background: #000; border: 3px solid var(--tet-gold); border-radius: 15px; font-size: 5rem; font-weight: 900; display: flex; align-items: center; justify-content: center; color: var(--tet-gold); }
        .spinning { color: #00ff00; border-color: #00ff00; }

        /* Danh s√°ch 6 ng∆∞·ªùi tr√∫ng gi·∫£i */
        .winner-list { margin-top: 30px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .winner-item { background: var(--tet-gold); color: #000; padding: 15px; border-radius: 15px; font-weight: bold; font-size: 1.2rem; border: 2px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }

        .btn-spin { padding: 20px 60px; font-size: 1.8rem; font-weight: 900; background: linear-gradient(145deg, #ffeb3b, #fbc02d); color: #8b0000; border: none; border-radius: 50px; cursor: pointer; box-shadow: 0 8px #f57f17; }
        .btn-spin:active { transform: translateY(4px); box-shadow: 0 4px #f57f17; }
        input[type=range] { width: 100%; accent-color: var(--tet-gold); }
        #qrcode { background: white; padding: 10px; border-radius: 10px; display: inline-block; }
    </style>
</head>
<body>

<div class="header">
    <h1 style="margin:0; color:var(--tet-gold); text-shadow: 2px 2px 5px #000;">üéä CH∆Ø∆†NG TR√åNH QUAY S·ªê T·∫§T NI√äN üéä</h1>
</div>

<div class="main-layout main-container">
    <div class="sidebar">
        <div id="qrcode"></div>
        <div style="margin: 20px 0;">
            <div style="font-size: 0.8rem;">√ÇM L∆Ø·ª¢NG</div>
            <input type="range" min="0" max="1" step="0.1" value="0.5" oninput="updateVol(this.value)">
        </div>
        <div style="font-size: 2rem; font-weight: 900; color: var(--tet-gold);" id="totalCount">0</div>
        <div>TH√ÄNH VI√äN</div>
        <button onclick="resetData()" style="margin-top:20px; color:white; background:none; border:1px solid #ff0000; padding:5px; cursor:pointer;">Reset danh s√°ch</button>
    </div>

    <div class="card">
        <div class="slot-group">
            <div id="d1" class="slot">0</div><div id="d2" class="slot">0</div><div id="d3" class="slot">0</div>
            <div id="d4" class="slot">0</div><div id="d5" class="slot">0</div><div id="d6" class="slot">0</div>
        </div>
        
        <button id="spinBtn" class="btn-spin" onclick="handleMegaSpin()">B·∫ÆT ƒê·∫¶U QUAY</button>

        <div style="margin-top: 30px; font-size: 1.5rem; color: var(--tet-gold);">üèÜ DANH S√ÅCH 6 NG∆Ø·ªúI MAY M·∫ÆN üèÜ</div>
        <div class="winner-list" id="winnerListUI">
            </div>
    </div>
</div>

<script>
    // --- D√°n Firebase Config c·ªßa th·∫ßy v√†o ƒë√¢y ---
    const firebaseConfig = {
        apiKey: "AIzaSyCZs0sGNdMxeS9cL_g9HeMf1LOlxzOUKf4",
        authDomain: "chamtn-26e8f.firebaseapp.com",
        projectId: "chamtn-26e8f",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const spinSound = new Audio("https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3");
    const winSound = new Audio("https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3");
    spinSound.loop = true;

    function updateVol(v) { spinSound.volume = v; winSound.volume = v; }

    async function handleMegaSpin() {
        const snap = await db.collection("participants").get();
        if(snap.size < 6) return alert("C·∫ßn t·ªëi thi·ªÉu 6 ng∆∞·ªùi ƒëƒÉng k√Ω!");
        
        const btn = document.getElementById('spinBtn');
        btn.disabled = true;
        document.getElementById('winnerListUI').innerHTML = "";
        
        // Ch·ªçn ng·∫´u nhi√™n 6 ng∆∞·ªùi kh√°c nhau
        let list = snap.docs.map(d => d.data());
        let winners = [];
        for(let i=0; i<6; i++) {
            let idx = Math.floor(Math.random() * list.length);
            winners.push(list.splice(idx, 1)[0]);
        }

        // Quay l·ªìng ƒë·ªÉ t√¨m ng∆∞·ªùi ƒë·∫ßu ti√™n (t·∫°o kh√¥ng kh√≠ k·ªãch t√≠nh)
        spinSound.currentTime = 0; spinSound.play();
        const mainWinner = winners[0];
        
        // G·ª≠i l·ªánh quay ƒë·ªìng b·ªô xu·ªëng t·∫•t c·∫£ HS (Ch·ªâ em n√†o l√† mainWinner m·ªõi k√™u)
        await db.collection("system_status").doc("current_draw").set({
            winningNumber: mainWinner.number, status: "SPINNING", ts: Date.now()
        });

        for(let i=0; i<6; i++) {
            const el = document.getElementById('d'+(i+1));
            el.classList.add('spinning');
            let start = Date.now();
            while(Date.now() - start < (1500 + i*400)) {
                el.innerText = Math.floor(Math.random()*10);
                await new Promise(r => setTimeout(r, 60));
            }
            el.innerText = mainWinner.number[i];
            el.classList.remove('spinning');
        }

        spinSound.pause(); winSound.play();
        confetti({ particleCount: 200, spread: 100 });

        // Hi·ªÉn th·ªã 6 ng∆∞·ªùi th·∫Øng l·∫ßn l∆∞·ª£t
        const listUI = document.getElementById('winnerListUI');
        winners.forEach((w, index) => {
            setTimeout(() => {
                const item = document.createElement('div');
                item.className = 'winner-item';
                item.innerText = `${index + 1}. ${w.name.toUpperCase()} (${w.class})`;
                listUI.appendChild(item);
                if(index > 0) winSound.play(); // K√™u chu√¥ng m·ªói khi hi·ªán 1 ng∆∞·ªùi m·ªõi
            }, index * 1000);
        });

        btn.disabled = false;
        await db.collection("system_status").doc("current_draw").update({ status: "DONE" });
    }

    const regUrl = window.location.href.replace('index.html', 'dangky.html');
    new QRCode(document.getElementById("qrcode"), { text: regUrl, width: 140, height: 140 });
    db.collection("participants").onSnapshot(s => document.getElementById('totalCount').innerText = s.size);
    async function resetData() { if(confirm("X√≥a h·∫øt?")) { const s = await db.collection("participants").get(); const b = db.batch(); s.docs.forEach(d => b.delete(d.ref)); await b.commit(); location.reload(); } }
</script>
</body>
</html>
